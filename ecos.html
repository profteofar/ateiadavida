<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecos-Logística: O Desafio da Floresta Dourada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fdfaf1; overflow-x: hidden; }
        h1, h2, h3, h4 { font-family: 'Crimson Pro', serif; }
        .forest-gradient { background: linear-gradient(135deg, #2d5a27 0%, #1a3c1a 100%); }
        .christmas-gradient { background: linear-gradient(135deg, #7f1d1d 0%, #450a0a 100%); }
        .progress-transition { transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); }
        .mode-transition { transition: background 0.7s ease, border-color 0.7s ease; }
        
        #energy-canvas {
            position: fixed;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1000;
        }

        .xmas-banner-animate {
            animation: slideDown 0.5s ease forwards, fadeOut 0.5s ease 4.5s forwards;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        .tutorial-modal {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>

    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^1.34.0"
      }
    }
    </script>
</head>
<body>
    <canvas id="energy-canvas"></canvas>
    <div id="app" class="min-h-screen pb-12">
        <div class="flex items-center justify-center min-h-screen">
            <div class="animate-pulse text-emerald-800 font-bold">A carregar ecossistema...</div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // Configuração fictícia para o ambiente de demonstração
        if (typeof window.process === 'undefined') {
            window.process = { env: { API_KEY: '' } };
        }

        const RECYCLE_EFFICIENCY = 0.85;
        const INITIAL_STATE = {
            nutrients: 120,
            wastePool: 0,
            tick: 0,
            isRunning: false,
            isChristmasMode: false,
            insight: "Inicie a simulação para observar a dinâmica de Gaia.",
            species: [
                { id: 'grass', name: 'Grama Dourada', level: 'Produtor', pop: 1000, max: 2000, icon: 'sprout', color: '#10b981' },
                { id: 'mouse', name: 'Rato de Campo', level: 'Consumidor 1', pop: 200, max: 800, icon: 'rat', color: '#3b82f6' },
                { id: 'snake', name: 'Cobra Cascavel', level: 'Consumidor 2', pop: 50, max: 250, icon: 'snake', color: '#f59e0b' },
                { id: 'primata', name: 'Primata Florestal', level: 'Consumidor 2', pop: 30, max: 150, icon: 'user', color: '#ec4899' },
                { id: 'hawk', name: 'Águia Real', level: 'Consumidor 3', pop: 15, max: 80, icon: 'bird', color: '#ef4444' },
                { id: 'parasita', name: 'Parasitas Sifão', level: 'Parasita', pop: 100, max: 500, icon: 'bug', color: '#78350f' },
                { id: 'fungi', name: 'Decompositores', level: 'Decompositor', pop: 400, max: 1000, icon: 'mushroom', color: '#8b5cf6' }
            ],
            relationships: [
                { id: 'grass_fungi', name: 'Rede Micorrízica', level: 85, lastA: 'COOPERATE', lastB: 'COOPERATE' },
                { id: 'primata_grass', name: 'Dispersão de Sementes', level: 60, lastA: 'COOPERATE', lastB: 'COOPERATE' }
            ]
        };

        let state = JSON.parse(JSON.stringify(INITIAL_STATE));
        let chart = null;
        let particles = [];
        const canvas = document.getElementById('energy-canvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        class Particle {
            constructor(startX, startY, endX, endY, color) {
                this.x = startX;
                this.y = startY;
                this.endX = endX;
                this.endY = endY;
                this.color = color;
                this.speed = 0.05 + Math.random() * 0.05;
                this.progress = 0;
                this.size = 3 + Math.random() * 4;
            }
            update() {
                this.progress += this.speed;
                this.x = this.x + (this.endX - this.x) * this.progress;
                this.y = this.y + (this.endY - this.y) * this.progress;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.shadowBlur = 10;
                ctx.shadowColor = this.color;
                ctx.fill();
            }
        }

        function createEnergyFlow(fromId, toId, color = '#fbbf24') {
            const fromEl = document.querySelector(`[data-species-id="${fromId}"]`);
            const toEl = document.querySelector(`[data-species-id="${toId}"]`);
            if (!fromEl || !toEl) return;

            const fromRect = fromEl.getBoundingClientRect();
            const toRect = toEl.getBoundingClientRect();

            for (let i = 0; i < 5; i++) {
                particles.push(new Particle(
                    fromRect.left + fromRect.width / 2,
                    fromRect.top + fromRect.height / 2,
                    toRect.left + toRect.width / 2,
                    toRect.top + toRect.height / 2,
                    color
                ));
            }
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles = particles.filter(p => p.progress < 1);
            particles.forEach(p => {
                p.update();
                p.draw();
            });
            requestAnimationFrame(animate);
        }
        animate();

        function updateSimulation() {
            if (!state.isRunning) return;
            state.tick++;

            const grass = state.species.find(s => s.id === 'grass');
            const mouse = state.species.find(s => s.id === 'mouse');
            const snake = state.species.find(s => s.id === 'snake');
            const primata = state.species.find(s => s.id === 'primata');
            const hawk = state.species.find(s => s.id === 'hawk');
            const parasita = state.species.find(s => s.id === 'parasita');
            const fungi = state.species.find(s => s.id === 'fungi');

            let growthModifier = 1.0;
            if (parasita && parasita.pop > 0) growthModifier -= (parasita.pop / parasita.max) * 0.4;
            const seedDispersal = (primata && primata.pop > 20) ? 1.2 : 1.0;
            
            const growth = Math.min(state.nutrients * 0.15 * growthModifier * seedDispersal, 80);
            if (grass && grass.pop > 0) {
                grass.pop += growth;
                state.nutrients -= growth * 0.5;
            }

            if (!state.isChristmasMode) {
                if (grass && mouse && grass.pop > 50) {
                    const e = Math.min(grass.pop * 0.08, 50);
                    grass.pop -= e; mouse.pop += e * 0.12;
                    if (state.tick % 3 === 0) createEnergyFlow('grass', 'mouse', '#3b82f6');
                }
                if (mouse && snake && mouse.pop > 30) {
                    const e = Math.min(mouse.pop * 0.1, 20);
                    mouse.pop -= e; snake.pop += e * 0.15;
                    if (state.tick % 5 === 0) createEnergyFlow('mouse', 'snake', '#f59e0b');
                }
                if (mouse && primata && mouse.pop > 30) {
                    const e = Math.min(mouse.pop * 0.08, 15);
                    mouse.pop -= e; primata.pop += e * 0.14;
                    if (state.tick % 6 === 0) createEnergyFlow('mouse', 'primata', '#ec4899');
                }
                if (snake && hawk && snake.pop > 10) {
                    const e = Math.min(snake.pop * 0.15, 10);
                    snake.pop -= e; hawk.pop += e * 0.12;
                    if (state.tick % 8 === 0) createEnergyFlow('snake', 'hawk', '#ef4444');
                }
                if (grass && parasita) {
                    const e = Math.min(grass.pop * 0.05, 15);
                    grass.pop -= e; parasita.pop += e * 0.2;
                }
            } else {
                state.species.forEach(s => { if (s.pop > 0) s.pop *= 1.012; });
                if (state.tick % 10 === 0) createEnergyFlow('fungi', 'grass', '#fbbf24');
            }

            state.relationships.forEach(rel => {
                const bonus = rel.level / 100;
                if (rel.id === 'primata_grass' && grass) grass.pop += 2 * bonus;
                rel.level = Math.min(100, rel.level + (state.isChristmasMode ? 1 : 0.1));
            });

            let totalLoss = 0;
            state.species.forEach(s => {
                const mortality = s.pop * (state.isChristmasMode ? 0.015 : 0.05);
                totalLoss += mortality;
                s.pop -= mortality;
                if (s.pop < 1) s.pop = 0;
            });
            state.wastePool += totalLoss;

            if (fungi) {
                const recycled = Math.min(state.wastePool, fungi.pop * 0.3);
                state.wastePool -= recycled;
                state.nutrients += recycled * RECYCLE_EFFICIENCY;
            }

            checkEcosystemHealth();
            if (state.tick % 20 === 0) fetchAIInsight();
            render();
        }

        function checkEcosystemHealth() {
            const mouse = state.species.find(s => s.id === 'mouse');
            const predators = state.species.filter(s => s.level === 'Consumidor 2');
            const totalPreds = predators.reduce((acc, s) => acc + s.pop, 0);
            if (totalPreds < 5 && mouse && mouse.pop > 600) {
                state.isRunning = false;
                showPopup("⚠️ EXPLOSÃO POPULACIONAL: Sem cobras ou primatas suficientes, os ratos consumiram toda a grama. O ecossistema colapsou por falta de regulação 'Top-Down'!");
            }
        }

        function showXmasBanner() {
            const banner = document.createElement('div');
            banner.className = "fixed top-6 left-1/2 -translate-x-1/2 z-[6000] w-[90%] max-w-2xl bg-white rounded-3xl shadow-2xl p-6 border-b-8 border-red-600 flex items-center gap-6 xmas-banner-animate";
            banner.innerHTML = `
                <div class="bg-red-100 p-4 rounded-2xl">
                    <i data-lucide="heart" class="w-10 h-10 text-red-600"></i>
                </div>
                <div>
                    <h4 class="font-bold text-gray-900 text-lg">Trégua Biológica Ativada</h4>
                    <p class="text-sm text-gray-600 leading-tight">No 'Modo Natal', a predação é suspensa. Espécies focam em <b>Mutualismo Facultativo</b>, onde a cooperação gera bónus de sobrevivência para todos.</p>
                </div>
            `;
            document.body.appendChild(banner);
            if (window.lucide) window.lucide.createIcons();
            setTimeout(() => banner.remove(), 5500);
        }

        function showTutorial() {
            const overlay = document.createElement('div');
            overlay.className = "fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center z-[8000] p-4";
            overlay.innerHTML = `
                <div class="bg-white rounded-[2.5rem] w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl tutorial-modal">
                    <div class="sticky top-0 bg-white/80 backdrop-blur p-6 border-b flex justify-between items-center">
                        <h2 class="text-3xl font-black text-emerald-900 flex items-center gap-3">
                            <i data-lucide="book-open" class="text-emerald-600"></i> Guia de Campo: Floresta Dourada
                        </h2>
                        <button id="close-tutorial" class="p-3 hover:bg-gray-100 rounded-full transition">
                            <i data-lucide="x" class="w-8 h-8 text-gray-400"></i>
                        </button>
                    </div>
                    <div class="p-8 space-y-12">
                        <section class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            <div>
                                <h3 class="text-2xl font-bold mb-4 text-emerald-800">1. A Base da Vida (Produtores)</h3>
                                <p class="text-gray-600 leading-relaxed mb-4">Tudo começa com a <b>Grama Dourada</b>. Ela transforma nutrientes do solo e luz solar em biomassa. Sem produtores saudáveis, nenhum outro nível trófico pode sobreviver.</p>
                                <div class="bg-emerald-50 p-4 rounded-2xl flex items-center gap-4 border border-emerald-100">
                                    <i data-lucide="info" class="text-emerald-600"></i>
                                    <span class="text-sm italic">Dica: Os <b>Parasitas</b> reduzem a eficácia deste processo!</span>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-6 rounded-3xl border border-dashed border-gray-200">
                                <h4 class="font-bold mb-2 uppercase text-xs tracking-widest text-gray-400">Fluxo Unidirecional</h4>
                                <div class="flex items-center gap-2 justify-center py-4">
                                    <span class="p-2 bg-emerald-100 rounded-lg">Sol</span>
                                    <i data-lucide="arrow-right" class="text-gray-300"></i>
                                    <span class="p-2 bg-emerald-600 text-white rounded-lg">Produtor</span>
                                    <i data-lucide="arrow-right" class="text-gray-300"></i>
                                    <span class="p-2 bg-blue-500 text-white rounded-lg">Consumidor</span>
                                </div>
                                <p class="text-[10px] text-center text-gray-400 uppercase">A energia perde 90% da eficácia em cada salto.</p>
                            </div>
                        </section>

                        <section class="space-y-6">
                            <h3 class="text-2xl font-bold text-emerald-800">2. Regulação e Predação</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="p-6 bg-blue-50 rounded-3xl border border-blue-100">
                                    <i data-lucide="rat" class="w-8 h-8 text-blue-600 mb-4"></i>
                                    <h4 class="font-bold mb-2">Presas</h4>
                                    <p class="text-xs text-gray-600 leading-relaxed">Ratos de campo são o motor intermediário. Se crescerem demais, destroem a grama.</p>
                                </div>
                                <div class="p-6 bg-amber-50 rounded-3xl border border-amber-100">
                                    <i data-lucide="snake" class="w-8 h-8 text-amber-600 mb-4"></i>
                                    <h4 class="font-bold mb-2">Predadores</h4>
                                    <p class="text-xs text-gray-600 leading-relaxed">Cobras e Primatas controlam a população de ratos. É o controlo "Top-Down".</p>
                                </div>
                                <div class="p-6 bg-red-50 rounded-3xl border border-red-100">
                                    <i data-lucide="bird" class="w-8 h-8 text-red-600 mb-4"></i>
                                    <h4 class="font-bold mb-2">Topo de Cadeia</h4>
                                    <p class="text-xs text-gray-600 leading-relaxed">Águias Reais precisam de grandes áreas e populações saudáveis abaixo para prosperar.</p>
                                </div>
                            </div>
                        </section>

                        <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-purple-950 text-white p-8 rounded-[2rem] shadow-xl">
                                <h3 class="text-2xl font-bold mb-4 flex items-center gap-3">
                                    <i data-lucide="recycle" class="text-purple-400"></i> 3. Ciclo da Matéria
                                </h3>
                                <p class="text-sm opacity-80 leading-relaxed mb-6">Ao contrário da energia, a matéria é <b>cíclica</b>. Decompositores (Fungos) pegam nos resíduos de todos e devolvem Nutrientes ao solo para a Grama.</p>
                                <div class="flex items-center gap-4 justify-around border-t border-white/10 pt-6">
                                    <div class="text-center"><i data-lucide="skull" class="block mx-auto mb-1"></i><span class="text-[10px] uppercase">Morte</span></div>
                                    <i data-lucide="refresh-cw" class="animate-spin-slow"></i>
                                    <div class="text-center"><i data-lucide="database" class="block mx-auto mb-1"></i><span class="text-[10px] uppercase">Nutrientes</span></div>
                                </div>
                            </div>
                            <div class="bg-red-800 text-white p-8 rounded-[2rem] shadow-xl">
                                <h3 class="text-2xl font-bold mb-4 flex items-center gap-3">
                                    <i data-lucide="gift" class="text-red-300"></i> 4. Noite de Natal
                                </h3>
                                <p class="text-sm opacity-80 leading-relaxed mb-6">Ativa o <b>Mutualismo</b>. Nesta trégua, a predação para. As espécies cooperam, aumentando as taxas de sobrevivência coletiva através da harmonia sistémica.</p>
                                <ul class="text-xs space-y-2 opacity-90">
                                    <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-400"></i> Suspensão de ataques</li>
                                    <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-400"></i> Bónus de regeneração</li>
                                    <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-400"></i> Estabilização de populações</li>
                                </ul>
                            </div>
                        </section>
                        <div class="text-center pb-8 border-t pt-8">
                            <button id="close-tutorial-btn" class="px-12 py-4 bg-emerald-800 text-white font-black rounded-2xl hover:bg-emerald-900 transition shadow-xl">ENTENDI O DESAFIO!</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            if (window.lucide) window.lucide.createIcons();
            
            const close = () => overlay.remove();
            document.getElementById('close-tutorial').onclick = close;
            document.getElementById('close-tutorial-btn').onclick = close;
        }

        async function fetchAIInsight() {
            const key = ""; // API Key fornecida pelo ambiente
            if (!key) return;
            try {
                const ai = new GoogleGenAI({ apiKey: key });
                const response = await ai.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: `Status: Nutrientes=${state.nutrients.toFixed(0)}, Natal=${state.isChristmasMode}. Dê uma dica científica curta sobre a importância dos Primatas na floresta.`,
                });
                state.insight = response.text || state.insight;
                render();
            } catch (e) {}
        }

        function showPopup(msg) {
            const overlay = document.createElement('div');
            overlay.className = "fixed inset-0 bg-black/80 flex items-center justify-center z-[7000] p-6";
            overlay.innerHTML = `
                <div class="bg-white rounded-[2rem] p-8 max-w-md w-full shadow-2xl border-t-[12px] border-red-600 text-center animate-in zoom-in duration-300">
                    <i data-lucide="alert-octagon" class="w-16 h-16 text-red-600 mx-auto mb-4"></i>
                    <h2 class="text-3xl font-black mb-4 font-serif text-gray-900">Alerta de Gaia</h2>
                    <p class="text-gray-600 mb-8 leading-relaxed font-medium">${msg}</p>
                    <button id="reset-pop" class="w-full py-5 bg-emerald-800 text-white font-black rounded-2xl hover:bg-emerald-900 transition shadow-xl uppercase tracking-widest">Tentar Equilibrar</button>
                </div>
            `;
            document.body.appendChild(overlay);
            if (window.lucide) window.lucide.createIcons();
            document.getElementById('reset-pop').onclick = () => {
                state = JSON.parse(JSON.stringify(INITIAL_STATE));
                overlay.remove();
                render();
            };
        }

        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            const isXmas = state.isChristmasMode;

            app.innerHTML = `
                <header class="p-8 text-white text-center shadow-xl border-b-4 border-amber-950 mode-transition ${isXmas ? 'christmas-gradient' : 'forest-gradient'}">
                    <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex gap-2">
                            <button id="back-home" class="group flex items-center gap-3 px-5 py-2.5 bg-white/10 hover:bg-white/20 rounded-xl transition-all text-sm font-bold border border-white/5">
                                <i data-lucide="x-circle" class="w-5 h-5 group-hover:scale-110 transition-transform"></i> Fechar Simulador
                            </button>
                            <button id="open-tutorial" class="flex items-center gap-3 px-5 py-2.5 bg-emerald-600/30 hover:bg-emerald-600/50 rounded-xl transition-all text-sm font-bold border border-emerald-400/30">
                                <i data-lucide="book-open" class="w-5 h-5"></i> Guia de Campo
                            </button>
                        </div>
                        <div class="flex flex-col items-center">
                            <div class="flex items-center gap-3 mb-1">
                                <i data-lucide="${isXmas ? 'sparkles' : 'leaf'}" class="w-10 h-10 ${isXmas ? 'text-red-300' : 'text-emerald-400'} animate-pulse"></i>
                                <h1 class="text-4xl font-bold italic tracking-tight">Ecos-Logística</h1>
                            </div>
                            <span class="text-xs uppercase tracking-[0.3em] opacity-60 font-black">Sinfonia da Floresta Dourada</span>
                        </div>
                        <div class="bg-black/20 px-6 py-2 rounded-2xl border border-white/5 backdrop-blur-md">
                            <span class="text-[10px] uppercase opacity-50 font-black block">Monitorização</span>
                            <span class="font-mono text-lg font-bold italic">Ciclo ${state.tick}</span>
                        </div>
                    </div>
                </header>

                <main class="max-w-7xl mx-auto mt-10 px-4 grid grid-cols-1 lg:grid-cols-12 gap-8 relative">
                    <div class="lg:col-span-8 space-y-8">
                        <div class="glass-panel p-8 rounded-[2.5rem] shadow-sm border border-emerald-100/50">
                            <div class="flex justify-between items-center mb-8">
                                <h2 class="text-2xl font-bold text-emerald-950 flex items-center gap-3">
                                    <i data-lucide="biohazard" class="text-emerald-600"></i> Níveis Tróficos
                                </h2>
                                <div class="flex gap-3">
                                    <button id="toggle-sim" class="px-8 py-3 rounded-2xl font-black shadow-lg transition-all transform hover:scale-105 ${state.isRunning ? 'bg-amber-100 text-amber-900' : 'bg-emerald-800 text-white'}">
                                        ${state.isRunning ? 'PAUSAR' : 'INICIAR'}
                                    </button>
                                    <button id="reset-sim" class="p-4 bg-gray-100 rounded-2xl hover:bg-gray-200 transition-colors">
                                        <i data-lucide="refresh-cw" class="w-5 h-5 text-gray-600"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                                ${state.species.map(s => `
                                    <div data-species-id="${s.id}" class="p-6 rounded-3xl border-2 transition-all duration-500 relative overflow-hidden ${s.pop <= 0 ? 'border-red-100 bg-red-50 grayscale' : 'border-emerald-50 bg-white shadow-sm hover:shadow-md'}">
                                        <div class="flex items-center gap-4 mb-4">
                                            <div class="w-14 h-14 bg-gray-50 rounded-2xl flex items-center justify-center">
                                                <i data-lucide="${s.icon}" class="w-8 h-8" style="color: ${s.pop > 0 ? s.color : '#94a3b8'}"></i>
                                            </div>
                                            <div>
                                                <h3 class="font-bold text-gray-900">${s.name}</h3>
                                                <span class="text-[10px] font-black uppercase text-gray-400">${s.level}</span>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex justify-between text-[10px] font-black">
                                                <span class="text-gray-400">BIOMASSA</span>
                                                <span style="color: ${s.color}">${s.pop.toFixed(0)}</span>
                                            </div>
                                            <div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                                <div class="h-full progress-transition" style="width: ${Math.min(100, (s.pop / s.max) * 100)}%; background-color: ${s.color}"></div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="glass-panel p-8 rounded-[2.5rem] shadow-sm border border-emerald-100/50 h-[350px]">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>

                    <div class="lg:col-span-4 space-y-8">
                        <section class="bg-emerald-950 text-white p-8 rounded-[2.5rem] shadow-2xl relative overflow-hidden">
                            <h2 class="text-xl font-bold mb-6 flex items-center gap-3">
                                <i data-lucide="recycle" class="text-emerald-400"></i> Matriz Abiótica
                            </h2>
                            <div class="space-y-8">
                                <div>
                                    <div class="flex justify-between text-xs mb-2 opacity-60 uppercase font-black">Resíduos Orgânicos</div>
                                    <div class="h-4 bg-white/5 rounded-full p-0.5 border border-white/10">
                                        <div class="h-full bg-amber-500 rounded-full progress-transition" style="width: ${Math.min(100, state.wastePool / 5)}%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs mb-2 opacity-60 uppercase font-black">Nutrientes do Solo</div>
                                    <div class="h-4 bg-white/5 rounded-full p-0.5 border border-white/10">
                                        <div class="h-full bg-blue-400 rounded-full progress-transition" style="width: ${Math.min(100, state.nutrients / 1.5)}%"></div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <section class="glass-panel p-8 rounded-[2.5rem] border border-blue-100 shadow-sm">
                            <h2 class="text-lg font-bold mb-6 text-blue-950 flex items-center gap-3">
                                <i data-lucide="heart-handshake" class="text-blue-600"></i> Redes Simbióticas
                            </h2>
                            <div class="space-y-5">
                                ${state.relationships.map(rel => `
                                    <div class="bg-blue-50/40 p-5 rounded-[1.5rem] border border-blue-100/50">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-[10px] font-black uppercase text-blue-900">${rel.name}</span>
                                            <span class="text-xs font-bold text-blue-600">${rel.level.toFixed(0)}%</span>
                                        </div>
                                        <div class="flex gap-1.5 h-1.5">
                                            <div class="flex-1 rounded-full ${rel.lastA === 'COOPERATE' ? 'bg-emerald-500' : 'bg-red-500'}"></div>
                                            <div class="flex-1 rounded-full ${rel.lastB === 'COOPERATE' ? 'bg-emerald-500' : 'bg-red-500'}"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </section>

                        <button id="christmas-toggle" class="w-full p-6 rounded-[2rem] flex items-center justify-between shadow-xl transition-all duration-700 hover:scale-[1.02] ${isXmas ? 'bg-red-800 text-white' : 'bg-white text-emerald-950 border-2 border-emerald-100'}">
                            <div class="text-left">
                                <p class="text-[10px] font-black uppercase opacity-60 mb-1">TRÉGUA DE GAIA</p>
                                <p class="font-bold text-lg italic">Noite de Natal</p>
                            </div>
                            <i data-lucide="gift" class="w-10 h-10 ${isXmas ? 'animate-bounce' : 'opacity-20'}"></i>
                        </button>

                        <div class="bg-emerald-50 p-6 rounded-[2rem] border-l-[6px] border-emerald-600 shadow-sm">
                            <h3 class="text-[10px] font-black uppercase text-emerald-800 mb-2 tracking-widest">Observações IA</h3>
                            <p class="text-sm text-gray-700 italic leading-relaxed font-medium">"${state.insight}"</p>
                        </div>
                    </div>
                </main>
            `;

            if (window.lucide) window.lucide.createIcons();
            initChart();

            document.getElementById('toggle-sim').onclick = () => { state.isRunning = !state.isRunning; render(); };
            document.getElementById('reset-sim').onclick = () => { state = JSON.parse(JSON.stringify(INITIAL_STATE)); render(); };
            document.getElementById('open-tutorial').onclick = showTutorial;
            document.getElementById('christmas-toggle').onclick = () => { 
                state.isChristmasMode = !state.isChristmasMode; 
                if (state.isChristmasMode) showXmasBanner();
                render(); 
            };
            
            // MODIFICAÇÃO SOLICITADA: Fechar o separador atual
            document.getElementById('back-home').onclick = () => { 
                window.close(); 
            };
        }

        function initChart() {
            const ctx = document.getElementById('mainChart');
            if (!ctx || !window.Chart) return;
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: state.species.map(s => s.name),
                    datasets: [{
                        data: state.species.map(s => s.pop),
                        backgroundColor: state.species.map(s => s.color),
                        borderRadius: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { display: false, beginAtZero: true }, x: { grid: { display: false } } }
                }
            });
        }

        setInterval(updateSimulation, 1000);
        window.addEventListener('DOMContentLoaded', render);
    </script>
</body>
</html>